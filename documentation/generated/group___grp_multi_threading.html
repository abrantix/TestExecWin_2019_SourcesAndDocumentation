<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>TestExecWindow: Do not forget to deal with multi threading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="MyStyles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">TestExecWindow
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___grp_multi_threading.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Do not forget to deal with multi threading<div class="ingroups"><a class="el" href="group___grp_design.html">Internal Design</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>Overview:</p><ul>
<li><a class="el" href="group___grp_multi_threading.html#threading_problem">The problem - unknown threads may call</a></li>
<li><a class="el" href="group___grp_multi_threading.html#threading_solution">A simple solution - synchronize via GUI thread</a></li>
</ul>
<p><a class="anchor" id="threading_problem"></a> </p><h2>The problem - unknown threads may call</h2>
<p>Within TestExecWindow many interactions start with pushing a button at the GUI. Those actions are executed within the safe main GUI thread (dispatcher thread).</p>
<p>But we also react on asynhronous events which will arrive on some notification thread:</p>
<ul>
<li>When the test executable terminates we get informed by a system thread which is different from our GUI thread.</li>
<li>Visual Studio sends notifications when something has changed (e.g. new startup project). Currently it seems that those notifications will already arrive on the safe GUI thread. But can we be sure for future versions?</li>
</ul>
<p>Critical situations may occur when data are accessed both from GUI thread and some notification thread. Unsynchronized changes may lead to corrupt data and program crash. When concerning GUI elements (buttons, list boxes etc.) access is only allowed from GUI thread. Visual Studio will rise an exception when access is tried from some other thread.</p>
<p><a class="anchor" id="threading_solution"></a></p><h2>A simple solution - synchronize via GUI thread</h2>
<p>Assume we want to write a message to the log pane by calling the service function TestExecWindowControl.AddInfoToEventList. We cannot be sure which thread will call this function. But within GUI (TestExecWindowControl.xaml.cs) we can pass the call to the dispatcher thread: </p><div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> AddInfoToEventList(<span class="keywordtype">string</span> info)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Redirect to main GUI thread</span></div>
<div class="line">            lstEvents.Dispatcher.Invoke(<span class="keyword">new</span> Action(() =&gt; AddInfoToEventListFromGuiThread(info)));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> AddInfoToEventListFromGuiThread(<span class="keywordtype">string</span> info)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// here we are sure to be within GUI thread and we can</span></div>
<div class="line">            <span class="comment">// safely access the list box</span></div>
<div class="line">            lstEvents.Items.Add(info);<span class="comment"></span></div>
<div class="line"><span class="comment">            /// ...</span></div>
</div><!-- fragment --><p>An analogous problem occurs when we receive the message about the end of the test process within main class TestExecWindow. In this case we also use the GUI thread for synchronization: </p><div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> OnTestTerminated(<span class="keywordtype">bool</span> in_success, <span class="keywordtype">string</span> in_args, <span class="keywordtype">bool</span> in_memLeaksDetected, TimeSpan in_executionTime)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// This function is called when the test app terminates.</span></div>
<div class="line">            <span class="comment">// The call may arrive on any system thread and needs to be synchronized.</span></div>
<div class="line">            <span class="comment">// Simply pass all data to GUI where the main GUI thread (dispatcher thread)</span></div>
<div class="line">            <span class="comment">// can be used for synchronization.</span></div>
<div class="line">            Gui().TestTerminated(in_success, in_args, in_memLeaksDetected, in_executionTime);</div>
<div class="line">        }</div>
</div><!-- fragment --><p> The GUI again dispatches to the safe GUI thread: </p><div class="fragment"><div class="line">        <span class="keyword">public</span> <span class="keywordtype">void</span> TestTerminated(<span class="keywordtype">bool</span> in_success, <span class="keywordtype">string</span> in_args, <span class="keywordtype">bool</span> in_memLeaksDetected, TimeSpan in_executionTime)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// For safe updating of status data process within GUI thread</span></div>
<div class="line">            this.Dispatcher.Invoke(<span class="keyword">new</span> Action(() =&gt;</div>
<div class="line">                TestTerminatedWithinGuiThread(in_success, <span class="stringliteral">&quot;&quot;</span>, in_args, in_memLeaksDetected, in_executionTime)));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keywordtype">void</span> TestTerminatedWithinGuiThread(<span class="keywordtype">bool</span> in_success, <span class="keywordtype">string</span> infoAboutTest, <span class="keywordtype">string</span> in_args, <span class="keywordtype">bool</span> in_memLeaksDetected, TimeSpan in_executionTime)</div>
<div class="line">        {</div>
<div class="line">            m_executionTimer.Stop();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Display execution status</span></div>
<div class="line">            <span class="keywordtype">string</span> info = in_args;</div>
<div class="line">            <span class="keywordflow">if</span> (info == <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line">            {</div>
<div class="line">                info = <span class="stringliteral">&quot;&lt;no args set&gt;&quot;</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">string</span> durationStr;</div>
<div class="line">            <span class="keywordflow">if</span> (in_executionTime.TotalSeconds &lt; 1.0)</div>
<div class="line">            {</div>
<div class="line">                durationStr = <span class="stringliteral">&quot;&lt;1s &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">double</span> totalNumMinutes = in_executionTime.TotalSeconds / 60.0;</div>
<div class="line">                durationStr = totalNumMinutes.ToString(<span class="stringliteral">&quot;F1&quot;</span>)+ <span class="stringliteral">&quot;m &quot;</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">//int totalNumSeconds = Convert.ToInt32(Math.Round(in_executionTime.TotalSeconds));</span></div>
<div class="line">            <span class="comment">//int totalNumMinutes = totalNumSeconds / 60;</span></div>
<div class="line">            <span class="comment">//int numSeconds = totalNumSeconds % 60;</span></div>
<div class="line">            <span class="comment">//int numSecondsAsDecimalMinute = numSeconds / 6;</span></div>
<div class="line">            <span class="comment">//string durationStr = totalNumMinutes + &quot;,&quot; + numSecondsAsDecimalMinute + &quot;m &quot;;</span></div>
<div class="line"></div>
<div class="line">            WriteLine(1, (!in_success ? <span class="stringliteral">&quot;FAILED: &quot;</span> : (in_memLeaksDetected ? <span class="stringliteral">&quot;FAILED (MEM_LEAKS): &quot;</span> : <span class="stringliteral">&quot;OK: &quot;</span>))</div>
<div class="line">                + durationStr + GetInfoAboutCurrentTest() + <span class="stringliteral">&quot; &quot;</span> + info);</div>
<div class="line">            <span class="keywordtype">bool</span> failure = !in_success || in_memLeaksDetected;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">int</span> idx = (int)m_curRunMode;</div>
<div class="line">            ++m_numExecutedTests[idx];</div>
<div class="line">            <span class="keywordflow">if</span> (failure)</div>
<div class="line">            {</div>
<div class="line">                ++m_numFailedTests[idx];</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">bool</span> testSucceededUpToNow = (m_numFailedTests[idx] == 0);</div>
<div class="line">            <span class="comment">// Safe update of state variables and refresh</span></div>
<div class="line">            <span class="comment">// of GUI controls within GUI thread</span></div>
<div class="line">            SetState(testSucceededUpToNow);<span class="comment"></span></div>
<div class="line"><span class="comment">            /// ...</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Mar 4 2019 13:44:51 for TestExecWindow by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
